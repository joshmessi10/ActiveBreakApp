<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Active Break - Detección de Postura</title>

    <!-- Session Validation - Must load FIRST -->
    <script src="auth-guard.js"></script>
    <script>
      checkClientSession();
    </script>

    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <!-- MediaPipe Pose Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3/dist/pose-detection.min.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  </head>
  <body>
    <header>
      <h1><i data-feather="activity"></i> Active Break</h1>
      <nav>
        <a href="index.html" class="active" title="Inicio">
          <i data-feather="home"></i>
        </a>
        <a
          href="#"
          id="nav-stats"
          title="Estadísticas"
          onclick="document.getElementById('stats-modal').setAttribute('aria-hidden', 'false'); return false;"
        >
          <i data-feather="bar-chart-2"></i>
        </a>
        <a href="settings.html" title="Configuración">
          <i data-feather="settings"></i>
        </a>
        <a
          href="#"
          id="nav-logout"
          title="Volver a Inicio"
          onclick="logout(); return false;"
          style="margin-left: auto"
        >
          <i data-feather="log-out"></i>
        </a>
      </nav>
    </header>

    <main class="ab-layout">
      <!-- Columna izquierda: cámara + feedback + controles -->
      <section class="ab-left">
        <section id="camera-container">
          <video id="video" autoplay playsinline></video>
          <canvas id="output"></canvas>
        </section>

        <div class="ab-controls">
          <button id="toggle-btn" class="ab-toggle ab-toggle--red">
            Pausar
          </button>
        </div>
      </section>

      <!-- Columna derecha: HUD (Postura, Tiempo, Alertas) -->
      <aside class="ab-right">
        <div class="stats-container">
          <div class="stat-card" id="posture-card">
            <h3>Postura</h3>
            <div id="visual-guide-container"></div>
            <div id="posture-detail" class="posture-detail">
              Bienvenido a ActiveBreak ✨
            </div>
          </div>

          <div class="stat-card" id="session-card">
            <h3>Tiempo sesión</h3>
            <p id="session-time">00:00</p>
          </div>

          <div class="stat-card" id="break-card">
            <h3>Próximo descanso</h3>
            <p id="break-time">--:--</p>
          </div>

          <div class="stat-card" id="alerts-card">
            <h3>Alertas</h3>
            <p id="alerts-count">0</p>
          </div>
        </div>
      </aside>
    </main>

    <div class="modal" id="admin-gate" aria-hidden="true">
      <div class="modal__backdrop" data-close></div>
      <div
        class="modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="adminGateTitle"
      >
        <h2 id="adminGateTitle">Acceso de Administrador</h2>
        <p class="muted">
          Ingresa tus credenciales de administrador para continuar a Ajustes.
        </p>

        <form id="adminGateForm" class="row" autocomplete="on">
          <label for="gateEmail">Correo</label>
          <input
            id="gateEmail"
            type="email"
            required
            placeholder="admin@tu-org.com"
          />
          <label for="gatePass">Contraseña</label>
          <input
            id="gatePass"
            type="password"
            required
            placeholder="••••••••"
          />
          <button class="btn" type="submit">Continuar</button>
          <div id="gateMsg" class="muted" style="margin-top: 6px"></div>
        </form>

        <button
          class="modal__close"
          type="button"
          data-close
          aria-label="Cerrar"
        >
          ✕
        </button>
      </div>
    </div>

    <!-- ===== Modal de Estadísticas (en vivo, sesión actual) ===== -->
    <div class="modal" id="stats-modal" aria-hidden="true">
      <div class="modal__backdrop" data-close></div>

      <div
        class="modal__dialog modal__dialog--wide"
        role="dialog"
        aria-modal="true"
        aria-labelledby="statsTitle"
      >
        <button
          class="modal__close"
          type="button"
          data-close
          aria-label="Cerrar"
        >
          ✕
        </button>

        <h2 id="statsTitle">Estadísticas de la sesión</h2>

        <div class="stats-kpis">
          <div class="kpi kpi--correct">
            <span class="kpi__label">Tiempo postura correcta</span>
            <span class="kpi__value" id="kpi-correct">00:00:00</span>
          </div>
          <div class="kpi kpi--incorrect">
            <span class="kpi__label">Tiempo postura incorrecta</span>
            <span class="kpi__value" id="kpi-incorrect">00:00:00</span>
          </div>
          <div class="kpi kpi--alerts">
            <span class="kpi__label">Alertas</span>
            <span class="kpi__value" id="kpi-alerts">0</span>
          </div>
        </div>

        <!-- Trend Analysis Container -->
        <div
          id="trend-analysis-container"
          class="trend-stats"
          style="display: none"
        ></div>

        <!-- Chart Container for Analytics -->
        <div class="chart-container" style="width: 100%; margin-bottom: 20px">
          <canvas id="postureChart"></canvas>
        </div>

        <!-- Date Range Filter Controls -->
        <div class="stats-filters">
          <div class="filter-group">
            <label for="startDate">Fecha inicio:</label>
            <input type="date" id="startDate" class="stats-filter-input" />
          </div>
          <div class="filter-group">
            <label for="endDate">Fecha fin:</label>
            <input type="date" id="endDate" class="stats-filter-input" />
          </div>
          <div class="filter-actions">
            <button type="button" id="filterButton" class="btn">Filtrar</button>
            <button type="button" id="resetButton" class="btn btn-secondary">
              Resetear
            </button>
          </div>
        </div>

        <div class="stats-table-wrap">
          <table class="history" id="stats-table">
            <thead>
              <tr>
                <th>Hora</th>
                <th>Evento</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS -->
            </tbody>
          </table>
        </div>

        <div class="pagination-controls">
          <button type="button" id="prevPage" class="btn btn-secondary">
            ← Anterior
          </button>
          <span id="pageInfo" style="margin: 0 1rem; font-weight: 500"
            >Página 1 de 1</span
          >
          <button type="button" id="nextPage" class="btn btn-secondary">
            Siguiente →
          </button>
        </div>

        <div class="stats-actions">
          <button class="btn" id="stats-export">Exportar CSV (sesión)</button>
        </div>
      </div>
    </div>

    <!-- ===== Interactive Break Overlay ===== -->
    <div id="break-overlay" style="display: none">
      <div class="break-modal">
        <div class="break-content-wrapper">
          <!-- Camera Preview Section -->
          <div class="break-camera-preview">
            <div id="break-camera-container">
              <!-- The actual camera elements will be moved here by JS -->
            </div>
          </div>

          <!-- Instructions Section -->
          <div class="break-instructions">
            <h1 id="break-title">¡Hora de la Pausa!</h1>
            <p id="break-progress">Ejercicio 1 de 4</p>

            <div class="break-exercise-card" id="break-card">
              <h2 id="break-exercise-name">[Nombre del Ejercicio]</h2>

              <!-- Video container for stretching demonstrations -->
              <div class="break-video-container" id="break-video-container">
                <video id="break-video" controls preload="none" muted loop>
                  <source id="break-video-source" src="" type="video/mp4" />
                  Tu navegador no soporta la reproducción de video.
                </video>
              </div>

              <p id="break-exercise-desc">[Descripción del ejercicio...]</p>

              <div class="break-validation">
                <span id="break-status-text">Colócate en posición...</span>
                <div class="break-timer-container">
                  <div class="break-timer-bar" id="break-timer-bar"></div>
                  <span id="break-countdown" class="break-countdown">10s</span>
                </div>
              </div>
            </div>

            <button id="break-skip-btn" class="btn btn-secondary">
              Saltar Ejercicio
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>© 2025 Active Break — Versión de desarrollo</p>
    </footer>

    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
      feather.replace();
    </script>
    <script src="script.js"></script>
  </body>
</html>
