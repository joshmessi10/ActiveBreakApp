%% ActiveBreakApp - System Architecture Diagram
%% Version: 3.0 (Database Migration Edition)
%% Last Updated: January 2025
%% Status: 100% Production Ready - Database-based architecture
%% 
%% Key Features Visualized:
%% - SQLite3 database with 5 tables (users, user_settings, user_stats, posture_events, alert_events)
%% - bcrypt authentication with role-based access control
%% - 8 IPC handlers for database operations (settings, stats, events, modal data)
%% - Admin dashboard with user management CRUD
%% - Session-based tracking with automatic event logging
%% - MoveNet AI with 3-rule military-grade classification
%% - Chart.js visualizations with trend analysis
%% - Native OS notifications with break reminders and exercise suggestions
%% - CSV export functionality in statistics modal

graph TB
    %% Electron Main Process
    MainProcess["<b>Electron Main Process</b><br/>(main.js)<br/>---<br/>• Creates BrowserWindow<br/>• Handles IPC messages<br/>• Native notifications<br/>• Database operations"]
    
    %% Entry Point
    Landing["<b>Landing Page</b><br/>(landing.html)<br/>---<br/>• App entry point<br/>• User routing"]
    
    %% Admin Flow
    AdminLogin["<b>Admin Login</b><br/>(admin/admin-login.html)<br/>---<br/>• Authentication form<br/>• Database validation<br/>• Session guard"]
    AdminRegister["<b>Admin Register</b><br/>(admin/admin-register.html)<br/>---<br/>• Registration form<br/>• bcrypt hashing"]
    AdminDashboard["<b>Admin Dashboard</b><br/>(admin/admin-welcome.html)<br/>---<br/>• User management UI<br/>• CRUD operations<br/>• Navigation bar (home, register, settings, logout)<br/>• Session guard"]
    
    %% Client Flow
    ClientLogin["<b>Client Login</b><br/>(client/client-login.html)<br/>---<br/>• Authentication form<br/>• Database validation<br/>• Direct redirect to app"]
    ClientRegister["<b>Client Register</b><br/>(client/client-register.html)<br/>---<br/>• Registration form<br/>• bcrypt hashing"]
    
    %% Core AI App
    CoreApp["<b>Core AI App</b><br/>(index.html)<br/>---<br/>• Video feed<br/>• Canvas overlay<br/>• Status display<br/>• Client-only access<br/>• Session guard"]
    
    %% Core Logic
    ScriptJS["<b>AI Logic</b><br/>(script.js)<br/>---<br/>• MoveNet Lightning<br/>• 17 keypoints detection<br/>• 3-rule validation (15%, 50%, 10%)<br/>• Database event logging<br/>• Session tracking (start/end)<br/>• Notification triggers<br/>• Statistics modal w/ Chart.js<br/>• CSV export<br/>• Date-range filtering<br/>• Trend analysis"]
    
    SettingsJS["<b>Settings</b><br/>(settings.js)<br/>---<br/>• Load/save via IPC<br/>• Database persistence<br/>• 4 settings (sensitivity,<br/>  notifications, threshold,<br/>  break interval)<br/>• Role-agnostic access<br/>• Dynamic navigation<br/>• Session guard"]
    
    AuthGuard["<b>Session Guard</b><br/>(auth-guard.js)<br/>---<br/>• Route protection<br/>• Role validation<br/>• Auto-redirect"]
    
    AdminDashboardJS["<b>Admin Logic</b><br/>(admin-dashboard.js)<br/>---<br/>• Load users<br/>• Delete users<br/>• Self-deletion detection<br/>• Table rendering<br/>• Logout with replace()"]
    
    %% IPC Bridge
    Preload["<b>IPC Bridge</b><br/>(preload.js)<br/>---<br/>• contextBridge API<br/>• Secure IPC channels<br/>• window.api methods (8):<br/>  - getSettings()<br/>  - saveSettings()<br/>  - getTotalStats()<br/>  - logSessionStats()<br/>  - logPostureEvent()<br/>  - logAlertEvent()<br/>  - getModalData()<br/>  - sendNotification()"]
    
    %% Notifications
    Notifications["<b>Native Notifications</b><br/>---<br/>• OS-level alerts<br/>• Sound enabled<br/>• Posture warnings<br/>• Break reminders"]
    
    %% Database
    Database[("<b>SQLite3 Database</b><br/>(data/users.sqlite)<br/>---<br/>• users (auth + roles)<br/>• user_settings (4 fields)<br/>• user_stats (cumulative)<br/>• posture_events (1:N)<br/>• alert_events (1:N)<br/>• bcrypt password hashing<br/>• Foreign key constraints<br/>• Cascading deletes")]
    
    %% localStorage
    LocalStorage[("<b>localStorage</b><br/>---<br/>• Session data only<br/>  (currentUser object)<br/>• Used for authentication<br/>• No persistent app data<br/>• All data in database")]
    
    %% Flow Connections
    MainProcess -->|loads| Landing
    MainProcess -.->|"Database ops"| Database
    
    Landing -->|"Admin button"| AdminLogin
    Landing -->|"Client button"| ClientLogin
    
    Landing -->|"Register link"| AdminRegister
    AdminLogin -->|"Register link"| AdminRegister
    AdminRegister -->|"Back to login"| AdminLogin
    AdminLogin -->|"IPC: auth:login"| Preload
    AdminRegister -->|"IPC: auth:register"| Preload
    AdminLogin -->|"Success"| AdminDashboard
    
    AdminDashboard -->|"Client register"| ClientRegister
    ClientRegister -->|"Back to dashboard"| AdminDashboard
    ClientLogin -->|"IPC: auth:login"| Preload
    ClientRegister -->|"IPC: auth:register"| Preload
    ClientLogin -->|"Success"| CoreApp
    
    CoreApp -->|"Loads"| ScriptJS
    CoreApp -->|"Navigation"| SettingsJS
    CoreApp -->|"Validates"| AuthGuard
    SettingsJS -->|"Validates"| AuthGuard
    AdminDashboard -->|"Validates"| AuthGuard
    AdminDashboard -->|"Loads"| AdminDashboardJS
    
    AdminDashboardJS -->|"IPC: admin:get-all-users"| Preload
    AdminDashboardJS -->|"IPC: admin:delete-user"| Preload
    
    ScriptJS -->|"IPC: get-settings"| Preload
    ScriptJS -->|"IPC: get-total-stats"| Preload
    ScriptJS -->|"IPC: log-session-stats"| Preload
    ScriptJS -->|"IPC: log-posture-event"| Preload
    ScriptJS -->|"IPC: log-alert-event"| Preload
    ScriptJS -->|"IPC: get-modal-data"| Preload
    ScriptJS -->|"IPC: notify:posture"| Preload
    
    SettingsJS -->|"IPC: get-settings"| Preload
    SettingsJS -->|"IPC: save-settings"| Preload
    
    Preload -->|"IPC messages"| MainProcess
    MainProcess -->|"Shows"| Notifications
    MainProcess -->|"Query/Insert/Update"| Database
    
    ScriptJS -.->|"Read session only"| LocalStorage
    SettingsJS -.->|"Read session only"| LocalStorage
    AuthGuard -.->|"Read sessions"| LocalStorage
    AdminLogin -.->|"Write session"| LocalStorage
    ClientLogin -.->|"Write session"| LocalStorage
    AdminDashboardJS -.->|"Self-deletion check"| LocalStorage
    
    %% Styling
    classDef mainProcess fill:#1f6feb,stroke:#388bfd,stroke-width:3px,color:#fff
    classDef auth fill:#238636,stroke:#2ea043,stroke-width:2px,color:#fff
    classDef coreApp fill:#a40e26,stroke:#f85149,stroke-width:3px,color:#fff
    classDef logic fill:#9a6700,stroke:#bf8700,stroke-width:2px,color:#fff
    classDef storage fill:#8250df,stroke:#986ee2,stroke-width:2px,color:#fff
    classDef ipc fill:#bf4b00,stroke:#d97706,stroke-width:2px,color:#fff
    classDef database fill:#0969da,stroke:#0969da,stroke-width:3px,color:#fff
    classDef guard fill:#d1242f,stroke:#f85149,stroke-width:2px,color:#fff
    
    class MainProcess,Notifications mainProcess
    class Landing,AdminLogin,AdminRegister,AdminDashboard,ClientLogin,ClientRegister auth
    class CoreApp coreApp
    class ScriptJS,SettingsJS,AdminDashboardJS logic
    class LocalStorage storage
    class Preload ipc
    class Database database
    class AuthGuard guard
